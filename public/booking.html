<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title> EasyBikes</title>
    <link rel="icon" href="img/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.9/css/uikit.min.css" />
    <!--<link href="https://fonts.googleapis.com/css?family=Permanent+Marker|Satisfy&display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css?family=Permanent+Marker&display=swap" rel="stylesheet">
     -->
    <link rel="stylesheet" href="./style.css">

    <link href="https://fonts.googleapis.com/css?family=Pacifico|Permanent+Marker|Satisfy&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- UIkit JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.9/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.9/js/uikit-icons.min.js"></script>
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->

    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <style>
            .overlay {
              position: fixed; /* Sit on top of the page content */
              display: none; /* Hidden by default */
              width: 100%; /* Full width (cover the whole page) */
              height: 100%; /* Full height (cover the whole page) */
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: rgba(0,0,0,0.5); /* Black background with opacity */
              z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
              cursor: pointer; /* Add a pointer on hover */
            }
             
            .load{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);
              /*change these sizes to fit into your project*/
              width:100px;
              height:100px;
            }
            
            .load hr{border:0;margin:0;width:40%;height:40%;position:absolute;border-radius:50%;animation:spin 2s ease infinite}
            
            .load :first-child{background:#19A68C;animation-delay:-1.5s}
            .load :nth-child(2){background:#F63D3A;animation-delay:-1s}
            .load :nth-child(3){background:#FDA543;animation-delay:-0.5s}
            .load :last-child{background:#193B48}
            
            @keyframes spin{
              0%,100%{transform:translate(0)}
              25%{transform:translate(160%)}
              50%{transform:translate(160%, 160%)}
              75%{transform:translate(0, 160%)}
            }
            
            
            </style>
            




</head>

<body onload="fname(),counter()">
    <div class="uk-position-top">
        <nav class="uk-navbar-container uk-navbar-transparent" uk-navbar>

            <ul class="uk-navbar-nav">
                <li class="uk-navbar-left@s"><a href="index.html"><img src="img/logo.png" width="50px" height="50px"></a>
                </li>
                <div class="uk-navbar-item uk-visible@m uk-margin-large-left">
                    <form>
                        <div class="uk-inline uk-form-width-large">
                            <select class=" uk-select uk-input uk-border-rounded " id="option">
                                <option>Location</option>
                                <option>Dehradoon</option>
                            </select>

                        </div>
                        <input class="uk-input uk-border-rounded uk-form-width-large" id="demo" readonly>
                        <button type="button"
                            class="uk-button uk-button-default uk-padding-small uk-padding-remove-top uk-padding-remove-bottom"
                            style="background:#1e90ff; color: white;" onclick="parameter()"><span uk-icon="icon: search"
                                class="icon"></span></button>
                    </form>
                </div>


            </ul>
            <div class="uk-navbar-right">

                <ul class="uk-navbar-nav">
                    <li>

                        <button uk-toggle="target: #md" style="border:1px transparent; "
                            class=" uk-navbar-toggle uk-hidden@m uk-visible@xs uk-button-default  " type="button"><span
                                uk-icon="icon: settings"></span>
                        </button>

                    </li>
                    <li><button uk-toggle="target: #mdtu" style="border:1px transparent; "
                        class=" uk-navbar-toggle uk-hidden@m uk-visible@xs uk-button-default  " type="button"><span
                          uk-icon="icon: menu"></span>
                      </button>
            
                      </li>
                </ul>
            </div>
            <div id="mdtu"  class=" uk-hidden@m" uk-offcanvas>
                <button class="uk-offcanvas-close" type="button" uk-close></button>
            <div class="uk-offcanvas-bar " >
            <ul style="list-style-type: none;">
                <li><a class="b" style="color:white" href="userauth.html"  id="name5">Login/sign-up</a></li>
                <li><a class="b" onclick="bookings()"  id="name7">My Bookings</a></li> 
                <!-- <li><a class="b" style="display:none" id="username"></a></li> -->
                <li><a class="b" href="index.html" style="display:none; "  onclick="logout()"id="name8">logout</a></li>
            </ul>
        </div>
            </div>
            <div id="md" uk-modal>
                <div class="uk-modal-dialog uk-modal-body">
                    <form>
                        <div class="uk-inline uk-form-width-large">
                            <select class=" uk-select uk-input uk-border-rounded " id="option1">
                                <option>Location</option>
                                <option>Dehradoon</option>
                            </select>

                        </div>
                        <input class="uk-input uk-border-rounded uk-form-width-large" id="ui" readonly>
                        <script>
                            $('#ui').daterangepicker({
                                "timePicker": true,
                                "alwaysShowCalendars": true,
                                "applyButtonClasses": "btn-secondary",
                                startDate: moment(),
                                endDate: moment().startOf('hour').add(24, 'hour'),
                                locale: {
                                    format: 'DD/M/YY hh:00 A'
                                },
                                minDate: moment().startOf('hour'),
                                "opens": "center"
                            });


                        </script>


                        <p class="uk-text-right">
                            <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                            <button class="uk-button uk-button-primary" onclick="parameter1()"
                                type="button">Rent</button>
                        </p>
                </div>


            </div>


        </nav>
    </div>
    <div style="margin-top:8%;">
        <div id="Booking" uk-grid>

        </div>
    </div>

    <div class="uk-section uk-margin-top">
        <p class="uk-h4" id="edit">Also Available in <span id="loc"></span> more Location </p>

        <div style="border: 2px dashed silver;" class="uk-grid-divider uk-child-width-expand@s " id="op" uk-grid>

        </div>
    </div>
    <div class="uk-section uk-section-secondary uk-light">
        <div>
            <div class="uk-align-left">
                <h3 class="uk-margin-left">Easy Bikes</h3>
            </div>
            <div class="uk-align-right">
                <span class="uk-margin-small-right uk-icon-button" uk-icon="mail"></span>
                <span class="uk-margin-small-right uk-icon-button" uk-icon="google"></span>
                <span class="uk-margin-small-right uk-icon-button" uk-icon="linkedin"></span>
                <span class="uk-margin-small-right uk-icon-button" uk-icon="instagram"></span>
                <span class="uk-margin-small-right uk-icon-button" uk-icon="twitter"></span>
                <span class="uk-margin-small-right uk-icon-button" uk-icon="facebook"></span>
            </div>

        </div>
    </div>
    <div class=" overlay" id="tre">
            <div class="  load" style="display:none;"id="ert">
                <hr/><hr/><hr/><hr/>
              </div>
            </div>
    <script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-database.js"></script>

    <script>
        
       var firebaseConfig = {
            apiKey: "AIzaSyB9IY9MVXJzgjBHZ-JegddvmJBU18xtB8U",
            authDomain: "rentalbike-115b4.firebaseapp.com",
            databaseURL: "https://rentalbike-115b4.firebaseio.com",
            projectId: "rentalbike-115b4",
            storageBucket: "rentalbike-115b4.appspot.com",
            messagingSenderId: "240683021274",
            appId: "1:240683021274:web:89ebd615402c9e525bc6e3"
        };

        // Initialize Firebase -->
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        let c = 0;
         function counter() {
                var inter = setInterval(function () {
                    document.getElementById('ert').style.display ="block";
                    document.getElementById('tre').style.display ="block";
                    //console.log(c);
                    c++; 
                    stop(c, inter);
                }, 30);
        }
        function stop(c, inter) { if (c == 113) {
            document.getElementById('ert').style.display ="none";
            document.getElementById('tre').style.display ="none";
             clearInterval(inter); } }
function fname() {
            if (localStorage.getItem('name')) {
                
                let nme = localStorage.getItem('name');
                document.getElementById('name5').style.display='none';
                
                // document.getElementById('username').style.display='inline';
                // document.getElementById('username').innerHTML = '<span  class=" uk-text-danger uk-text bold" uk-icon="icon: user;"  ratio: 1.5"></span>'+nme; 
                document.getElementById('name7').style.display='inline';
                document.getElementById('name8').style.display='inline';
                
               // console.log("here2345");

            } 
            else {
                // console.log("here");
                 document.getElementById('name5').innerHTML = 'Login/Sign-up'; }
        }
        $('#demo').daterangepicker({
            "timePicker": true,
            "alwaysShowCalendars": true,
            "applyButtonClasses": "btn-secondary",
            startDate: moment(),
            endDate: moment().startOf('hour').add(24, 'hour'),
            locale: {
                format: 'DD/M/YY hh:00 A'
            },
            minDate: moment().startOf('hour'),
            "opens": "center"
        });


        function parameter() {
            var alphaExp = /^[a-zA-Z]+(([',. -][a-zA-Z ])?[a-zA-Z]*)*$/;
            let sd1 = $('#demo').val();
            
            var select = document.getElementById('option').value;
            var queryString = "?location=" + select + "&" + "Details=" + sd1;
          //  console.log("The value is here" + queryString);
            var location1 = "rent.html" + queryString;
            if (select == "Location") {
                alert("Please Choose a Location")

            }
            else {
            //    console.log(location1);
                window.location.href = location1;

            }
        }
        function parameter1() {

let sd1 = $('#ui').val();

var select1 = document.getElementById('option1').value;
var queryString = "?location=" + select1 + "&" + "Details=" + sd1;
//console.log("The value is here" + queryString);
var location1 = "rent.html" + queryString;

if (select1 !== "Location") {
  //console.log("yha hu bsdkee");
  
  window.location.href = location1;

}
  else {
    alert("Please Choose a Location") 
  
}
}
function bookings(){
                            
                            if(!localStorage.getItem('name')){
                                localStorage.setItem("href", "book");
                                window.location.href="userauth.html";

                            }

                            else{
                                var locate="cout_page.html"
                                window.location.href=locate;
                            }
                        }
                       

        var queryString1 = decodeURIComponent(window.location.search);
        queryString1 = queryString1.substring(1);
        var Mainqueries = queryString1.split("&");
        var Vendor = Mainqueries[1].split("=");
        var Vendorid = Vendor[1].split(",");
        var price1 = Mainqueries[2].split("=");
        var price = price1[1].split(",");
        // console.log(price[0] + "split   " + price[1]);
        var date = Mainqueries[3].split("=");
        var location1 = Mainqueries[4].split("=");
        let sd2 = date[1].split(" ");
        let checkIn = sd2[0];
        let checkOut = sd2[4];
        let inTime = sd2[1] + sd2[2];
        let outTime = sd2[5] + sd2[6];
        if (Vendorid.length > 1) {
            //        console.log("there1221");
            document.getElementById('loc').innerHTML = Vendorid.length - 1;
            //console.log("/Vendors/" + Vendorid[1]);
        }
        else if (Vendorid.length == 1) {
            //      console.log("here1221");
            document.getElementById('edit').innerHTML = "Not Available in any other location"
            
        }
        var amt_day1;
        var amt_hour1;
        var db = firebase.database();
        console.log(Vendorid[0]);
        db.ref("/bikesAdded/" + location1[1] + "/" + Vendorid[0]).on('value', function (data) {
            
            if (data.hasChild("amt_per_day")) {
                amt_day1 = data.val().amt_per_day;
                amt_hour1 = data.val().amt_per_hr;

            }
            else {
                //      console.log("outside");
                amt_day1 = "Not Available";
                amt_hour1 = data.val().amt_per_hr;
            }
            var id = data.val().bikeId;
            console.log(id);
            db.ref("/bikeList/" + id).on('value', function (Data) {
                //    console.log(Data.val().pic);
                //  console.log(Data.val().bikeName);

                db.ref("/Vendors/" + data.val().vendor).on('value', function (sanpshot) {

                    //    console.log(sanpshot.val().address);
                    //  console.log(sanpshot.val().name);
                    //console.log(sanpshot.val().city);
                    // console.log(sanpshot.val().shop_contact);
                    // console.log(sanpshot.val().verified);
                    // console.log(Vendorid.length - 1);
                    let vendor55 = data.val().vendor;
                    document.getElementById('Booking').innerHTML = '<div class=" uk-width-1-2@s">' +
                        ' <img class="uk-margin-large-top" src=' + Data.val().pic + ' uk-img>' +
                        '</div>' +
                        '<div class=" uk-width-expand@s ">' +
                        '<div class=" uk-h1 uk-text uk-text-center">' + Data.val().bikeName + '</div>' +
                        '<hr class="uk-divider-icon">' +
                        '<p class="uk-text uk-h3">' +
                        sanpshot.val().address + '</p>' +
                        '<div>' +
                        '<p style="color:black;" class="uk-text-bold uk-text-left"><span >&#x20b9; ' + amt_hour1 + '/hr </span>' + '<br>' + '<span >&#x20b9;' + amt_day1 + '/day</span>' +
                        '<p style="color:black;" class="uk-text-bold ">Total amount : &#x20b9; ' + price[0] + '</p>' +

                        '</div>' +
                        '<div class="uk-margin">' +
                        '<p><span uk-icon="icon: location; ratio: 2"></span><span class="uk-text-warning">' + location1[1] + '</span>' +
                        '</p>' +
                        '<p><span uk-icon="icon:phone; ratio:2"></span>' + sanpshot.val().shop_contact + '</p>' +

                        '<table class="uk-table">' +

                        '<thead>' +
                        '<tr>' +
                        '<th>Start Date</th>' +
                        '<th>End Date</th>' +
                        '<th>Pick-time</th>' +
                        '<th>Drop-time</th>' +
                        '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                        '<tr>' +
                        '<td>' + checkIn + '</td>' +
                        '<td>' + checkOut + '</td>' +
                        '<td>' + inTime + '</td>' +
                        '<td>' + outTime + '</td>' +
                        '</tr>' +

                        ' </tbody>' +
                        ' </table>' +
                        '</div>' +
                        '<button type="button" class="uk-button uk-align-center uk-button-primary uk-width-1-2" onclick="rented(' + data.val().bikeId + ', ' + price[0] + ', `' + checkIn + '` , `' + checkOut + '` , `' + vendor55 + '`, `' + inTime + '`,`' + outTime + '`)"> Book' +
                        'Now</button></div>';
                });
            });

        });
        var amt_day;
        var amt_hour;
        localStorage.removeItem("href");

        for (let i = 1; i <= Vendorid.length - 1; i++) {
            var price3 = price[i];

            db.ref("/bikesAdded/" + location1[1] + "/" + Vendorid[i]).on('value', function (data1) {
                var id1 = data1.val().bikeId;
                if (data1.hasChild("amt_per_day")) {
                    amt_day = data1.val().amt_per_day;
                    amt_hour = data1.val().amt_per_hr;
                }
                else {
                    amt_day = "Not Available";
                    amt_hour = data1.val().amt_per_hr;
                }
                db.ref("/bikeList/" + id1).on('value', function (Data1) {

        //            console.log(data1.val().vendor + "vendor vendors");
                    db.ref("/Vendors/" + data1.val().vendor).on('value', function (sanpshot1) {

                        // console.log("Yash Kalra");

                        // console.log(sanpshot1.val().address);
                        // console.log(sanpshot1.val().name);
                        // console.log(sanpshot1.val().city);
                        // console.log(sanpshot1.val().shop_contact);
                        // console.log(sanpshot1.val().verified);

                        document.getElementById('op').innerHTML = document.getElementById('op').innerHTML +


                            ' <div class="uk-align-left uk-margin-top">' +
                            '    <p class="uk-text uk-h3 uk-text-center">' +
                            sanpshot1.val().address + '</p>' +
                            '<p  class="uk-text-center"><span uk-icon="icon:phone; ratio:1"></span>' + sanpshot1.val().shop_contact + '</p>' +

                            '</div>' +

                            '<div class="uk-margin-top ">' +

                            '<p style="color:black;" class="uk-text-bold uk-text-center"><span class="uk-align-left uk-margin-left@s">&#x20b9; ' + amt_hour + '/hr </span>' + '<span class="uk-align-right uk-margin-right@s">&#x20b9;' + amt_day + '/day</span>' +
                            '</p>' + '<br>' +
                            '<p style="color:black;" class="uk-text-bold uk-text-center">Total amount : &#x20b9;' + price3 + '</p>' +
                            '</div>' +


                            '<div class="uk-align-right ">' +

                            '<button type="button" class="uk-button uk-button-primary  uk-align-center uk-margin-medium-top" onclick="rented(' + data1.val().bikeId + ', ' + price3 + ', `' + checkIn + '` , `' + checkOut + '` , `' + data1.val().vendor + '`, `' + inTime + '`,`' + outTime + '`)"> Book' +
                            'Now</button>' +

                            '</div>';
                        // onclick="rented(' + vendorId3 + ',' + price3 + ')"
                    });
                });
            });
        }

        //console.log(date);
        function rented(val1, val2, val3, val4, val5, val6, val7) {
            var today = new Date().getTime();
            var ar = [];
            var bikeid = val1;
            var cost = val2;
            var c_date = val3;
            var o_date = val4;
            var vendorId4 = val5;
            var i_time = val6;
            var o_time = val7;
            var month = c_date.slice(3, 5);
            var Dey = c_date.slice(0, 2)
            var year = c_date.slice(6, 8);
            var month1 = o_date.slice(3, 5);
            var Dey1 = o_date.slice(0, 2)
            var year1 = o_date.slice(6, 8);
            var p_date = month + "/" + Dey + "/" + "20" + year;
            var d_date = month1 + "/" + Dey1 + "/" + "20" + year1;

        
            var sdate;
            var edate;
        
            if (i_time[5] == 'A' && o_time[5] == 'A') {
                i_time = i_time.replace("AM", ":00");
                o_time = o_time.replace("AM", ":00");
                sdate = p_date + " " + i_time;
                edate = d_date + " " + o_time;
            }

            else if (i_time[5] == 'P' && o_time[5] == 'P') {
                i_time = parseInt(i_time) + 12;
                o_time = parseInt(o_time) + 12;

                i_time = i_time.toString() + ":00:00";
                o_time = o_time.toString() + ":00:00";

                sdate = p_date + " " + i_time;
                edate = d_date + " " + o_time;

            }
            else if (i_time[5] == 'A' && o_time[5] == 'P') {
                i_time = i_time.replace("AM", ":00");
                o_time = parseInt(o_time) + 12;
                sdate = p_date + " " + i_time;
                o_time = o_time.toString() + ":00:00";
                edate = d_date + " " + o_time;
            }
            else if (i_time[5] == 'P' && o_time[5] == 'A') {
                i_time = parseInt(i_time) + 12;
                i_time = i_time.toString + ":00:00";
                edate = p_date + " " + i_time;
                o_time = o_time.replace("AM", ":00");
                edate = d_date + " " + o_time;
            }
          //  console.log(sdate);
            var date = new Date(sdate); // some mock date
            var milliseconds = date.getTime();
            console.log(sdate, edate);
            var date1 = new Date(edate); // some mock date
            var milliseconds1 = date1.getTime();
            console.log(milliseconds1);

            // location4 = "?" + Mainqueries[3] + "&" + Mainqueries[4] + "&" + "vendorId=" + "X88MSLuFhNTfInpQ9DngIDjfABA2_36" + "&" + "price=" + "70 ";
            var num = localStorage.getItem("num");
            var db = firebase.database();
            if (num) {
                db.ref("/users/").on('value', function (data) {
                    if (data.hasChild(num)) {
                        var name = localStorage.getItem("name");
                        var bookingid = Bookingid();
                        var pin1 = Pin();
                        db.ref("/bookings/" + location1[1] + "/").once("value").then(function (snapshot1) {
                            var flag = 0;
                            var temp = 0;
                            for (let i = 0; i < Object.keys(snapshot1.val()).length; i++) {
                                db.ref("/bookings/" + location1[1] + "/" + Object.keys(snapshot1.val())[i]).once("value").then(function (snapshot) {
                                    if (snapshot.val().contact == num && snapshot.val().cancel == "no") {
                                        flag = 1;
                                        var Time4 = snapshot.val().to;
                                    }
                                    if (flag == 0 && i == Object.keys(snapshot1.val()).length - 1) {
                                        db.ref('/bookings/' + location1[1] + '/' + bookingid).set({
                                            bikeId: bikeid,
                                            bookedBy: name,
                                            bookingId: bookingid,
                                            cancel: "no",
                                            charge: cost,
                                            contact: num,
                                            from: milliseconds,
                                            pin: pin1,
                                            taken: "no",
                                            to: milliseconds1,
                                            vendorId: vendorId4,

                                        });
                                       // window.location = "cout_page.html" ;
                                       console.log("start Date"+milliseconds+"end Date"+milliseconds1);
                                    }
                                    else if (flag == 1) {
                                        if (parseInt(Time4) > parseInt(temp)) {
                                            temp = Time4;
                                        }
                                        if (i == Object.keys(snapshot1.val()).length - 1) {

                                            if (parseInt(temp) > parseInt(today)) {
                                               // console.log("Deep");
                                                alert("Please Drop the first Bike After that you can book anoother one");
                                                      window.location = "index.html";
                                            }
                                            else {
                                                //console.log(vendorId4);
                                                db.ref('/bookings/' + location1[1] + '/' + bookingid).set({
                                                    bikeId: bikeid,
                                                    bookedBy: name,
                                                    bookingId: bookingid,
                                                    cancel: "no",
                                                    charge: cost,
                                                    contact: num,
                                                    from: milliseconds,
                                                    pin: pin1,
                                                    taken: "no",
                                                    to: milliseconds1,
                                                    vendorId: vendorId4,

                                                });
                                                window.location = "cout_page.html" ;
                                            }

                                        }

                                    }
                                })
                            }
                        });

                    }




                });

            }

            else {
                window.location = "userauth.html";
            }
        }

        function a(flag, key) {
            console.log(flag + key);
        }

        function Pin() {

            var digits = '0123456789';

            var otpLength = 4;

            var otp = '';

            for (let i = 1; i <= otpLength; i++) {

                var index = Math.floor(Math.random() * (digits.length));

                otp = otp + digits[index];

            }

            return otp;

        }

        function Bookingid() {

            var digits = '0123456789';

            var otpLength = 6;

            var otp = '';

            for (let i = 1; i <= otpLength; i++) {

                var index = Math.floor(Math.random() * (digits.length));

                otp = otp + digits[index];

            }

            return otp;

        }


    </script>

</body>

</html>